<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Profil ‚Äî Nara M√ºzik</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="../css/styles.css">
  <style>
    :root{ --bg:#0b0b0b; --text:#eaeaea; --panel:#121214; --muted:#9aa3ae; --accent:#77c2ff; --accent-contrast:#0a1118; --border: rgba(255,255,255,0.06); --elev-1: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); --input-bg:#0f1113; }
    :root[data-theme="light"]{ --bg:#f8fafc; --text:#0f172a; --panel:#ffffff; --muted:#5b6778; --accent:#2563eb; --accent-contrast:#ffffff; --border: rgba(15,23,42,0.08); --elev-1: linear-gradient(180deg, rgba(2,6,23,0.02), rgba(2,6,23,0.01)); --input-bg:#f1f5f9; }
    html,body{height:100%}
    body{ background:var(--bg); color:var(--text); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; padding-top:72px; }
    .mainnav{ position:fixed; top:0; left:0; right:0; z-index:1039; border-bottom:1px solid var(--border); }
    .card{ background:var(--elev-1); border:1px solid var(--border) }
    :root[data-theme="light"] .text-light{ color: var(--text) !important }
    :root[data-theme="light"] .bg-dark{ background-color: var(--input-bg) !important }
    :root[data-theme="light"] .form-control.bg-dark,
    :root[data-theme="light"] .form-select.bg-dark{ background-color: var(--input-bg) !important; color: var(--text) !important; border-color: var(--border) !important }
    :root[data-theme="light"] .btn-outline-light{ color: var(--text) !important; border-color: var(--border) !important }
    :root[data-theme="light"] .btn-outline-light:hover{ background: var(--text) !important; color: var(--accent-contrast) !important }
    /* Force white text in dark mode specifically for profile page */
    :root:not([data-theme="light"]) body,
    :root:not([data-theme="light"]) .card,
    :root:not([data-theme="light"]) .card * {
      color:#ffffff !important;
    }
    :root:not([data-theme="light"]) .text-muted { color:#cbd5e1 !important; }
    :root:not([data-theme="light"]) .form-control,
    :root:not([data-theme="light"]) .form-select { color:#ffffff !important; background-color:#0f1113 !important; border-color: rgba(255,255,255,0.12) !important; }
    /* Dark theme navbar styles for profile page */
    :root:not([data-theme="light"]) .mainnav {
      background: #000000 !important;
    }
    :root:not([data-theme="light"]) .mainnav .navbar-brand,
    :root:not([data-theme="light"]) .mainnav .nav-link,
    :root:not([data-theme="light"]) .mainnav a,
    :root:not([data-theme="light"]) .mainnav .btn,
    :root:not([data-theme="light"]) .mainnav .form-control,
    :root:not([data-theme="light"]) .mainnav .form-select {
      color: #ffffff !important;
    }
    :root:not([data-theme="light"]) .mainnav .navbar-brand:hover,
    :root:not([data-theme="light"]) .mainnav .nav-link:hover,
    :root:not([data-theme="light"]) .mainnav a:hover {
      color: #cccccc !important;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark mainnav" id="mainNavbar">
    <div class="container-fluid">
      <a class="navbar-brand" href="../index.html" data-lang="home">Nara M√ºzik</a>
      <div class="ms-auto d-flex align-items-center gap-2">
        <select id="language-toggle">
          <option value="en">EN</option>
          <option value="tr">TR</option>
        </select>
        <button id="themeToggle" class="btn btn-outline-light btn-sm">‚òÄÔ∏è</button>
        <div id="authButtons"></div>
      </div>
    </div>
  </nav>

  <main class="container mt-4">
    <div class="row g-4">
      <!-- Sidebar -->
      <aside class="col-lg-4 sidebar">
        <div class="widget">
          <h6>üîç Pop√ºler</h6>
          <div class="small-list" id="sidebarPopularPosts">
            <div class="text-center py-3">
              <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">Y√ºkleniyor...</span>
              </div>
              <div class="small text-muted mt-2">Pop√ºler g√∂nderiler y√ºkleniyor...</div>
            </div>
          </div>
        </div>

        <div class="widget">
          <h6>üßæ Son Yorumlar</h6>
          <div class="small-list" id="sidebarRecentComments">
            <div class="text-center py-3">
              <div class="spinner-border spinner-border-sm text-primary" role="status">
                <span class="visually-hidden">Y√ºkleniyor...</span>
              </div>
              <div class="small text-muted mt-2">Son yorumlar y√ºkleniyor...</div>
            </div>
          </div>
        </div>

        <div class="widget">
          <h6>üóÇ Kategoriler</h6>
          <div class="d-flex flex-wrap gap-2">
            <a href="yenimuzik.html" class="badge bg-secondary text-light">Yeni M√ºzik</a>
            <a href="endustri.html" class="badge bg-secondary text-light">End√ºstri</a>
            <a href="degerlendirme.html" class="badge bg-secondary text-light">Deƒüerlendirme</a>
            <a href="album.html" class="badge bg-secondary text-light">Alb√ºm</a>
            <a href="roportaj.html" class="badge bg-secondary text-light">R√∂portaj</a>
            <a href="etkinlik.html" class="badge bg-secondary text-light">Etkinlik</a>
            <a href="dizifilm.html" class="badge bg-secondary text-light">Dizi&amp;Film</a>
          </div>
        </div>

        <div class="widget text-center">
          <h6>Topluluƒüa Katƒ±l</h6>
          <p class="small text-muted mb-0">G√∂nderi payla≈ümak i√ßin √ºye olun.</p>
          <div class="mt-2">
            <button class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#registerModal">√úye Ol</button>
          </div>
        </div>
      </aside>

      <div class="col-lg-8">
        <div class="card p-3">
          <div class="d-flex align-items-center gap-3">
            <img id="profAvatar" class="rounded-circle" style="width:64px;height:64px; object-fit:cover" src="" alt="avatar">
            <div>
              <h5 id="profUsername" class="mb-1">Kullanƒ±cƒ± <span id="profRole" class="badge bg-dark ms-2 d-none"></span></h5>
              <div id="profEmail" class="text-muted small"></div>
            </div>
          </div>
          <div class="mt-3 d-flex gap-2">
            <button id="logoutBtn" class="btn btn-outline-light btn-sm" data-lang="logout">√áƒ±kƒ±≈ü</button>
          </div>
          <div class="mt-3">
            <label class="form-label small" data-lang="avatarUrl">Avatar URL</label>
            <div class="input-group">
              <input id="avatarUrlInput" class="form-control form-control-sm" data-placeholder-lang="avatarUrlPlaceholder" placeholder="https://... (fotoƒüraf/gif)">
              <button id="saveAvatarBtn" class="btn btn-sm btn-primary" data-lang="save">Kaydet</button>
            </div>
            <div class="form-text" data-lang="avatarUrlHelp">URL bo≈ü kaydedilirse avatar kaldƒ±rƒ±lƒ±r.</div>
          </div>
          <div class="mt-2">
            <label class="form-label small" data-lang="uploadFile">Veya dosya y√ºkle</label>
            <form id="avatarUploadForm" class="d-flex gap-2">
              <input id="avatarFile" type="file" accept="image/*" class="form-control form-control-sm">
              <button class="btn btn-sm btn-outline-light" type="submit" data-lang="upload">Y√ºkle</button>
            </form>
          </div>
        </div>
      </div>
      <div class="col-lg-8">
        <!-- Favorites Section -->
        <div class="card mb-4">
          <div class="card-header">
            <h5 class="mb-0" data-lang="myFavorites">Favori Alb√ºmlerim</h5>
          </div>
          <div class="card-body">
            <div id="favoritesContainer">
              <div class="text-center py-3">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Y√ºkleniyor...</span>
                </div>
                <p class="mt-2 text-muted" data-lang="loadingFavorites">Favori alb√ºmleriniz y√ºkleniyor...</p>
              </div>
            </div>
          </div>
        </div>

        <!-- My Posts Section -->
        <div class="card">
          <div class="card-header">
            <h5 class="mb-0" data-lang="myPosts">G√∂nderilerim</h5>
          </div>
          <div class="card-body">
            <div class="row g-3" id="myPosts"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="text-center py-4 mt-5">
    <div class="container">
      <small class="text-muted">¬© <span id="year"></span> Nara M√ºzik ‚Äî <span data-lang="allRightsReserved">T√ºm haklarƒ± saklƒ±dƒ±r.</span></small>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../js/app.js"></script>
  <script src="../js/lang.js"></script>
  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
    const root = document.documentElement; const savedTheme = localStorage.getItem('theme') || 'dark';
    function applyTheme(theme){ const nav = document.getElementById('mainNavbar'); if(theme==='light'){ root.setAttribute('data-theme','light'); nav.classList.remove('navbar-dark'); nav.classList.add('navbar-light'); document.getElementById('themeToggle').textContent='üåô'; } else { root.removeAttribute('data-theme'); nav.classList.remove('navbar-light'); nav.classList.add('navbar-dark'); document.getElementById('themeToggle').textContent='‚òÄÔ∏è'; } }
    applyTheme(savedTheme);
    document.getElementById('themeToggle').addEventListener('click',()=>{ const next = root.getAttribute('data-theme')==='light' ? 'dark':'light'; localStorage.setItem('theme', next); applyTheme(next); });

    // Initialize auth UI
    if (typeof updateAuthUI === 'function') {
      updateAuthUI();
    }

    // Auth check
    const user = JSON.parse(localStorage.getItem('user') || 'null');
    if (!user){ location.href = '../index.html'; }
    document.getElementById('profUsername').firstChild.nodeValue = user.username + ' ';
    document.getElementById('profEmail').textContent = user.email || '';
    const roleBadge = document.getElementById('profRole');
    if (roleBadge){
      const role = user.role || 'user';
      roleBadge.textContent = role;
      roleBadge.classList.remove('d-none');
      if (role==='superadmin'){ roleBadge.classList.add('bg-danger'); }
      else if (role==='admin'){ roleBadge.classList.add('bg-warning'); }
      else if (role==='moderator'){ roleBadge.classList.add('bg-primary'); }
    }
    if (user.avatarUrl){ document.getElementById('profAvatar').src = user.avatarUrl; } else { document.getElementById('profAvatar').src = 'https://ui-avatars.com/api/?name='+encodeURIComponent(user.username||'U')+'&background=0D8ABC&color=fff'; }
    document.getElementById('logoutBtn').addEventListener('click', ()=>{ localStorage.removeItem('user'); location.href = '../index.html'; });

    // Load favorite albums
    function loadFavoriteAlbums() {
      const favorites = JSON.parse(localStorage.getItem('favoriteAlbums') || '[]');
      const container = document.getElementById('favoritesContainer');
      
      if (favorites.length === 0) {
        container.innerHTML = `
          <div class="text-center py-4">
            <div class="text-muted mb-2">üéµ</div>
            <p class="text-muted mb-0" data-lang="noFavorites">Hen√ºz favori alb√ºm√ºn√ºz yok.</p>
            <small class="text-muted" data-lang="addFavorites">Alb√ºm inceleme sayfasƒ±ndan favori alb√ºmlerinizi ekleyebilirsiniz.</small>
          </div>
        `;
        return;
      }

      // Group favorites by artist for better display
      const groupedFavorites = favorites.reduce((acc, fav) => {
        if (!acc[fav.artistName]) {
          acc[fav.artistName] = [];
        }
        acc[fav.artistName].push(fav);
        return acc;
      }, {});

      container.innerHTML = Object.keys(groupedFavorites).map(artist => `
        <div class="mb-4">
          <h6 class="text-primary mb-3">${artist}</h6>
          <div class="row g-2">
            ${groupedFavorites[artist].map(fav => `
              <div class="col-md-6">
                <div class="card border-0 bg-light">
                  <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start">
                      <div class="flex-grow-1">
                        <h6 class="card-title mb-1">${fav.albumName}</h6>
                        <small class="text-muted">${new Date(fav.addedDate).toLocaleDateString('tr-TR')}</small>
                      </div>
                      <button class="btn btn-sm btn-outline-danger remove-favorite" 
                              data-album-id="${fav.albumId}" 
                              title="Favorilerden √áƒ±kar">
                        ‚úï
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            `).join('')}
          </div>
        </div>
      `).join('');

      // Add event listeners for remove buttons
      container.querySelectorAll('.remove-favorite').forEach(btn => {
        btn.addEventListener('click', function() {
          const albumId = this.getAttribute('data-album-id');
          removeFromFavorites(albumId);
        });
      });
    }

    // Remove album from favorites
    function removeFromFavorites(albumId) {
      const favorites = JSON.parse(localStorage.getItem('favoriteAlbums') || '[]');
      const updatedFavorites = favorites.filter(fav => fav.albumId !== albumId);
      localStorage.setItem('favoriteAlbums', JSON.stringify(updatedFavorites));
      loadFavoriteAlbums();
    }

    // Load my posts
    (async ()=>{
      try{
        const base = (typeof window !== 'undefined' && window.__API_BASE__) ? window.__API_BASE__ : 'http://localhost:4000';
        const res = await fetch(`${base}/api/users/${encodeURIComponent(user.id)}/posts`);
        const posts = await res.json();
        const el = document.getElementById('myPosts');
        if(!posts.length){ el.innerHTML = '<p>Hen√ºz g√∂nderiniz yok.</p>'; return; }
        el.innerHTML = posts.map(p=>`
          <div class="col-12">
            <article class="card p-3">
              <h6 class="mb-1">${p.title}</h6>
              <div class="meta mb-2 text-muted small">${new Date(p.createdAt).toLocaleString()} ‚Ä¢ ${p.category}</div>
              <p class="mb-0 text-truncate">${p.content}</p>
            </article>
          </div>
        `).join('');
      }catch(e){ console.error(e); }
    })();

    // Load favorites on page load
    loadFavoriteAlbums();

    // Load sidebar data
    async function loadSidebarData() {
      try {
        const base = (typeof window !== 'undefined' && window.__API_BASE__) ? window.__API_BASE__ : 'http://localhost:4000';
        
        // Load popular posts for sidebar
        const popularRes = await fetch(`${base}/api/posts/popular?limit=3`);
        const popularPosts = await popularRes.json();
        
        const sidebarPopular = document.getElementById('sidebarPopularPosts');
        if (popularPosts.length > 0) {
          sidebarPopular.innerHTML = popularPosts.map(post => `
            <div class="item">
              <img src="${post.imageUrl || 'https://images.unsplash.com/photo-1511671782779-c97d3d27a1d4?q=80&w=400&auto=format&fit=crop'}" alt="${post.title}" style="width: 50px; height: 50px; object-fit: cover;">
              <div>
                <div class="fw-semibold">${post.title}</div>
                <div class="meta">${post.views || 0} okuma</div>
              </div>
            </div>
          `).join('');
        } else {
          sidebarPopular.innerHTML = '<div class="text-muted small">Hen√ºz pop√ºler g√∂nderi yok.</div>';
        }

        // Load recent comments for sidebar
        const commentsRes = await fetch(`${base}/api/comments/recent?limit=3`);
        const recentComments = await commentsRes.json();
        
        const sidebarComments = document.getElementById('sidebarRecentComments');
        if (recentComments.length > 0) {
          sidebarComments.innerHTML = recentComments.map(comment => `
            <div class="item">
              <div>
                <div class="fw-semibold">${comment.author || 'Anonim'}</div>
                <div class="meta">"${comment.content.substring(0, 50)}${comment.content.length > 50 ? '...' : ''}" ‚Ä¢ ${new Date(comment.createdAt).toLocaleDateString('tr-TR')}</div>
              </div>
            </div>
          `).join('');
        } else {
          sidebarComments.innerHTML = '<div class="text-muted small">Hen√ºz yorum yok.</div>';
        }

      } catch (error) {
        console.error('Sidebar data loading error:', error);
        
        // Show error state
        document.getElementById('sidebarPopularPosts').innerHTML = '<div class="text-muted small">Veri y√ºklenemedi.</div>';
        document.getElementById('sidebarRecentComments').innerHTML = '<div class="text-muted small">Veri y√ºklenemedi.</div>';
      }
    }

    // Load sidebar data on page load
    loadSidebarData();

    // Avatar g√ºncelle
    document.getElementById('saveAvatarBtn').addEventListener('click', async ()=>{
      const url = document.getElementById('avatarUrlInput').value.trim();
      try{
        const token = localStorage.getItem('token');
        const r = await fetch((location.hostname.includes('localhost')? 'http://localhost:4000':'https://naramusic.onrender.com') + '/api/users/me', { method:'PUT', headers:{'Content-Type':'application/json', 'Authorization': `Bearer ${token}`}, body: JSON.stringify({ avatarUrl: url || null }) });
        const data = await r.json();
        if(data.error){ alert(data.error); return; }
        localStorage.setItem('user', JSON.stringify(data.user));
        document.getElementById('profAvatar').src = data.user.avatarUrl || ('https://ui-avatars.com/api/?name='+encodeURIComponent(data.user.username||'U')+'&background=0D8ABC&color=fff');
        alert('Avatar g√ºncellendi');
      }catch(err){ console.error(err); alert('Avatar g√ºncellenemedi'); }
    });

    // Dosya y√ºkle
    document.getElementById('avatarUploadForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const file = document.getElementById('avatarFile').files[0];
      if(!file){ alert('Dosya se√ßin'); return; }
      const token = localStorage.getItem('token');
      const fd = new FormData(); fd.append('avatar', file);
      try{
        const r = await fetch((location.hostname.includes('localhost')? 'http://localhost:4000':'https://naramusic.onrender.com') + '/api/users/me/avatar', { method:'POST', headers:{ 'Authorization': `Bearer ${token}` }, body: fd });
        const data = await r.json();
        if(data.error){ alert(data.error); return; }
        document.getElementById('profAvatar').src = data.avatarUrl;
        const u = JSON.parse(localStorage.getItem('user')||'{}'); u.avatarUrl = data.avatarUrl; localStorage.setItem('user', JSON.stringify(u));
        alert('Avatar y√ºklendi');
      }catch(err){ console.error(err); alert('Y√ºkleme ba≈üarƒ±sƒ±z'); }
    });

    // Dil se√ßimi lang.js tarafƒ±ndan y√∂netiliyor
  </script>

  <!-- Login Modal -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form id="loginForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" data-lang="login">Giri≈ü Yap</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input name="email" type="email" class="form-control mb-2" data-placeholder-lang="email" placeholder="Email" required>
          <input name="password" type="password" class="form-control" data-placeholder-lang="password" placeholder="Parola" required>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary w-100" data-lang="login">Giri≈ü</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Register Modal -->
  <div class="modal fade" id="registerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form id="registerForm" class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" data-lang="register">Kayƒ±t Ol</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input name="username" class="form-control mb-2" data-placeholder-lang="username" placeholder="Kullanƒ±cƒ± Adƒ±" required>
          <input name="email" type="email" class="form-control mb-2" data-placeholder-lang="email" placeholder="Email" required>
          <input name="password" type="password" class="form-control" data-placeholder-lang="password" placeholder="Parola" required>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-success w-100" data-lang="register">Kayƒ±t Ol</button>
        </div>
      </form>
    </div>
  </div>
</body>
</html>


